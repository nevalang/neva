<!DOCTYPE html>
<html>
<head>
  <style> body { margin: 0; } </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://esm.sh/three",
      "three/": "https://esm.sh/three/"
    }
  }
  </script>
</head>
<body>
  <div id="3d-graph"></div>

  <script type="module">
    import ForceGraph3D from 'https://esm.sh/3d-force-graph?external=three';
    import * as THREE from 'https://esm.sh/three';
    import * as d3 from 'https://esm.sh/d3';
    import SpriteText from 'https://esm.sh/three-spritetext?external=three';

    // Fix for "three" module resolution
    window.THREE = THREE;

    // Embedded IR Data
    const irData = {"funcs":[{"ref":"new","io":{"out":["__new__7/out:res"]},"msg":{"type":"int","int":-1,"union":{"tag":""}}},{"ref":"lock","io":{"in":["lock/in:data","lock/in:sig"],"out":["lock/out:data"]}},{"ref":"panic","io":{"in":["panic/in:data"]}},{"ref":"switch_router","io":{"in":["s/in:case[0]","s/in:data"],"out":["s/out:case[0]","s/out:else"]}},{"ref":"new_v2","io":{"in":["print_next_2_lines/print_second_line/__newv2__4/in:sig"],"out":["print_next_2_lines/print_second_line/__newv2__4/out:res"]},"msg":{"type":"string","str":"Take one down and pass it around, $0 bottles of beer on the wall.\n\n","union":{"tag":""}}},{"ref":"new_v2","io":{"in":["print_next_2_lines/print_second_line/__newv2__3/in:sig"],"out":["print_next_2_lines/print_second_line/__newv2__3/out:res"]},"msg":{"type":"string","str":"Take one down and pass it around, 1 bottle of beer on the wall.\n","union":{"tag":""}}},{"ref":"println","io":{"in":["print_next_2_lines/print_second_line/p1/in:data"],"out":["print_next_2_lines/print_second_line/p1/out:err","print_next_2_lines/print_second_line/p1/out:res"]}},{"ref":"printf","io":{"in":["print_next_2_lines/print_second_line/printf/in:args[0]","print_next_2_lines/print_second_line/printf/in:tpl"],"out":["print_next_2_lines/print_second_line/printf/out:err","print_next_2_lines/print_second_line/printf/out:sig"]}},{"ref":"new_v2","io":{"in":["print_next_2_lines/print_second_line/__newv2__1/in:sig"],"out":["print_next_2_lines/print_second_line/__newv2__1/out:res"]},"msg":{"type":"string","str":"Go to the store and buy some more, 99 bottles of beer on the wall.","union":{"tag":""}}},{"ref":"fan_out","io":{"in":["print_next_2_lines/print_second_line/__fan_out__2/in:data"],"out":["print_next_2_lines/print_second_line/__fan_out__2/out:data[0]","print_next_2_lines/print_second_line/__fan_out__2/out:data[1]"]}},{"ref":"lock","io":{"in":["print_next_2_lines/print_second_line/lock/in:data","print_next_2_lines/print_second_line/lock/in:sig"],"out":["print_next_2_lines/print_second_line/lock/out:data"]}},{"ref":"switch_router","io":{"in":["print_next_2_lines/print_second_line/s/in:case[0]","print_next_2_lines/print_second_line/s/in:case[1]","print_next_2_lines/print_second_line/s/in:case[2]","print_next_2_lines/print_second_line/s/in:data"],"out":["print_next_2_lines/print_second_line/s/out:case[0]","print_next_2_lines/print_second_line/s/out:case[1]","print_next_2_lines/print_second_line/s/out:case[2]","print_next_2_lines/print_second_line/s/out:else"]}},{"ref":"println","io":{"in":["print_next_2_lines/print_second_line/p3/in:data"],"out":["print_next_2_lines/print_second_line/p3/out:err","print_next_2_lines/print_second_line/p3/out:res"]}},{"ref":"new","io":{"out":["print_next_2_lines/print_second_line/__new__2/out:res"]},"msg":{"type":"int","union":{"tag":""}}},{"ref":"new","io":{"out":["print_next_2_lines/print_second_line/__new__3/out:res"]},"msg":{"type":"int","int":1,"union":{"tag":""}}},{"ref":"println","io":{"in":["print_next_2_lines/print_second_line/p2/in:data"],"out":["print_next_2_lines/print_second_line/p2/out:err","print_next_2_lines/print_second_line/p2/out:res"]}},{"ref":"fan_in","io":{"in":["print_next_2_lines/print_second_line/__fan_in__1/in:data[0]","print_next_2_lines/print_second_line/__fan_in__1/in:data[1]","print_next_2_lines/print_second_line/__fan_in__1/in:data[2]","print_next_2_lines/print_second_line/__fan_in__1/in:data[3]"],"out":["print_next_2_lines/print_second_line/__fan_in__1/out:res"]}},{"ref":"new_v2","io":{"in":["print_next_2_lines/print_second_line/__newv2__2/in:sig"],"out":["print_next_2_lines/print_second_line/__newv2__2/out:res"]},"msg":{"type":"string","str":"Take one down and pass it around, no more bottles of beer on the wall.\n","union":{"tag":""}}},{"ref":"fan_out","io":{"in":["print_next_2_lines/print_second_line/__fan_out__1/in:data"],"out":["print_next_2_lines/print_second_line/__fan_out__1/out:data[0]","print_next_2_lines/print_second_line/__fan_out__1/out:data[1]"]}},{"ref":"new","io":{"out":["print_next_2_lines/print_second_line/__new__1/out:res"]},"msg":{"type":"int","int":-1,"union":{"tag":""}}},{"ref":"int_dec","io":{"in":["print_next_2_lines/dec/in:data"],"out":["print_next_2_lines/dec/out:res"]}},{"ref":"printf","io":{"in":["print_next_2_lines/print_first_line/printf/in:args[0]","print_next_2_lines/print_first_line/printf/in:tpl"],"out":["print_next_2_lines/print_first_line/printf/out:err","print_next_2_lines/print_first_line/printf/out:sig"]}},{"ref":"switch_router","io":{"in":["print_next_2_lines/print_first_line/s/in:case[0]","print_next_2_lines/print_first_line/s/in:case[1]","print_next_2_lines/print_first_line/s/in:data"],"out":["print_next_2_lines/print_first_line/s/out:case[0]","print_next_2_lines/print_first_line/s/out:case[1]","print_next_2_lines/print_first_line/s/out:else"]}},{"ref":"println","io":{"in":["print_next_2_lines/print_first_line/p1/in:data"],"out":["print_next_2_lines/print_first_line/p1/out:err","print_next_2_lines/print_first_line/p1/out:res"]}},{"ref":"fan_out","io":{"in":["print_next_2_lines/print_first_line/__fan_out__3/in:data"],"out":["print_next_2_lines/print_first_line/__fan_out__3/out:data[0]","print_next_2_lines/print_first_line/__fan_out__3/out:data[1]"]}},{"ref":"new","io":{"out":["print_next_2_lines/print_first_line/__new__4/out:res"]},"msg":{"type":"int","union":{"tag":""}}},{"ref":"new","io":{"out":["print_next_2_lines/print_first_line/__new__5/out:res"]},"msg":{"type":"int","int":1,"union":{"tag":""}}},{"ref":"new_v2","io":{"in":["print_next_2_lines/print_first_line/__newv2__5/in:sig"],"out":["print_next_2_lines/print_first_line/__newv2__5/out:res"]},"msg":{"type":"string","str":"No more bottles of beer on the wall, no more bottles of beer.","union":{"tag":""}}},{"ref":"new_v2","io":{"in":["print_next_2_lines/print_first_line/__newv2__6/in:sig"],"out":["print_next_2_lines/print_first_line/__newv2__6/out:res"]},"msg":{"type":"string","str":"1 bottle of beer on the wall, 1 bottle of beer.","union":{"tag":""}}},{"ref":"println","io":{"in":["print_next_2_lines/print_first_line/p2/in:data"],"out":["print_next_2_lines/print_first_line/p2/out:err","print_next_2_lines/print_first_line/p2/out:res"]}},{"ref":"lock","io":{"in":["print_next_2_lines/print_first_line/lock/in:data","print_next_2_lines/print_first_line/lock/in:sig"],"out":["print_next_2_lines/print_first_line/lock/out:data"]}},{"ref":"fan_in","io":{"in":["print_next_2_lines/print_first_line/__fan_in__2/in:data[0]","print_next_2_lines/print_first_line/__fan_in__2/in:data[1]","print_next_2_lines/print_first_line/__fan_in__2/in:data[2]"],"out":["print_next_2_lines/print_first_line/__fan_in__2/out:res"]}},{"ref":"fan_out","io":{"in":["print_next_2_lines/print_first_line/__fan_out__4/in:data"],"out":["print_next_2_lines/print_first_line/__fan_out__4/out:data[0]","print_next_2_lines/print_first_line/__fan_out__4/out:data[1]"]}},{"ref":"new_v2","io":{"in":["print_next_2_lines/print_first_line/__newv2__7/in:sig"],"out":["print_next_2_lines/print_first_line/__newv2__7/out:res"]},"msg":{"type":"string","str":"$0 bottles of beer on the wall, $0 bottles of beer.\n","union":{"tag":""}}},{"ref":"new","io":{"out":["__new__6/out:res"]},"msg":{"type":"int","int":99,"union":{"tag":""}}},{"ref":"fan_in","io":{"in":["__fan_in__3/in:data[0]","__fan_in__3/in:data[1]"],"out":["__fan_in__3/out:res"]}}],"comment":"// module=@@ main=main compiler=0.32.0","connections":{"__fan_in__3/out:res":"print_next_2_lines/in:n","__new__6/out:res":"lock/in:data","__new__7/out:res":"s/in:case[0]","in:start":"lock/in:sig","lock/out:data":"__fan_in__3/in:data[0]","print_next_2_lines/dec/out:res":"print_next_2_lines/print_second_line/in:n","print_next_2_lines/in:n":"print_next_2_lines/print_first_line/in:n","print_next_2_lines/out:err":"panic/in:data","print_next_2_lines/out:n":"s/in:data","print_next_2_lines/print_first_line/__fan_in__2/out:res":"print_next_2_lines/print_first_line/lock/in:sig","print_next_2_lines/print_first_line/__fan_out__3/out:data[0]":"print_next_2_lines/print_first_line/s/in:data","print_next_2_lines/print_first_line/__fan_out__3/out:data[1]":"print_next_2_lines/print_first_line/lock/in:data","print_next_2_lines/print_first_line/__fan_out__4/out:data[0]":"print_next_2_lines/print_first_line/printf/in:args[0]","print_next_2_lines/print_first_line/__fan_out__4/out:data[1]":"print_next_2_lines/print_first_line/__newv2__7/in:sig","print_next_2_lines/print_first_line/__new__4/out:res":"print_next_2_lines/print_first_line/s/in:case[0]","print_next_2_lines/print_first_line/__new__5/out:res":"print_next_2_lines/print_first_line/s/in:case[1]","print_next_2_lines/print_first_line/__newv2__5/out:res":"print_next_2_lines/print_first_line/p1/in:data","print_next_2_lines/print_first_line/__newv2__6/out:res":"print_next_2_lines/print_first_line/p2/in:data","print_next_2_lines/print_first_line/__newv2__7/out:res":"print_next_2_lines/print_first_line/printf/in:tpl","print_next_2_lines/print_first_line/in:n":"print_next_2_lines/print_first_line/__fan_out__3/in:data","print_next_2_lines/print_first_line/lock/out:data":"print_next_2_lines/print_first_line/out:n","print_next_2_lines/print_first_line/out:err":"print_next_2_lines/out:err","print_next_2_lines/print_first_line/out:n":"print_next_2_lines/dec/in:data","print_next_2_lines/print_first_line/p1/out:err":"print_next_2_lines/print_first_line/out:err","print_next_2_lines/print_first_line/p1/out:res":"print_next_2_lines/print_first_line/__fan_in__2/in:data[0]","print_next_2_lines/print_first_line/p2/out:err":"print_next_2_lines/print_first_line/out:err","print_next_2_lines/print_first_line/p2/out:res":"print_next_2_lines/print_first_line/__fan_in__2/in:data[1]","print_next_2_lines/print_first_line/printf/out:err":"print_next_2_lines/print_first_line/out:err","print_next_2_lines/print_first_line/printf/out:sig":"print_next_2_lines/print_first_line/__fan_in__2/in:data[2]","print_next_2_lines/print_first_line/s/out:case[0]":"print_next_2_lines/print_first_line/__newv2__5/in:sig","print_next_2_lines/print_first_line/s/out:case[1]":"print_next_2_lines/print_first_line/__newv2__6/in:sig","print_next_2_lines/print_first_line/s/out:else":"print_next_2_lines/print_first_line/__fan_out__4/in:data","print_next_2_lines/print_second_line/__fan_in__1/out:res":"print_next_2_lines/print_second_line/lock/in:sig","print_next_2_lines/print_second_line/__fan_out__1/out:data[0]":"print_next_2_lines/print_second_line/s/in:data","print_next_2_lines/print_second_line/__fan_out__1/out:data[1]":"print_next_2_lines/print_second_line/lock/in:data","print_next_2_lines/print_second_line/__fan_out__2/out:data[0]":"print_next_2_lines/print_second_line/printf/in:args[0]","print_next_2_lines/print_second_line/__fan_out__2/out:data[1]":"print_next_2_lines/print_second_line/__newv2__4/in:sig","print_next_2_lines/print_second_line/__new__1/out:res":"print_next_2_lines/print_second_line/s/in:case[0]","print_next_2_lines/print_second_line/__new__2/out:res":"print_next_2_lines/print_second_line/s/in:case[1]","print_next_2_lines/print_second_line/__new__3/out:res":"print_next_2_lines/print_second_line/s/in:case[2]","print_next_2_lines/print_second_line/__newv2__1/out:res":"print_next_2_lines/print_second_line/p1/in:data","print_next_2_lines/print_second_line/__newv2__2/out:res":"print_next_2_lines/print_second_line/p2/in:data","print_next_2_lines/print_second_line/__newv2__3/out:res":"print_next_2_lines/print_second_line/p3/in:data","print_next_2_lines/print_second_line/__newv2__4/out:res":"print_next_2_lines/print_second_line/printf/in:tpl","print_next_2_lines/print_second_line/in:n":"print_next_2_lines/print_second_line/__fan_out__1/in:data","print_next_2_lines/print_second_line/lock/out:data":"print_next_2_lines/print_second_line/out:n","print_next_2_lines/print_second_line/out:err":"print_next_2_lines/out:err","print_next_2_lines/print_second_line/out:n":"print_next_2_lines/out:n","print_next_2_lines/print_second_line/p1/out:err":"print_next_2_lines/print_second_line/out:err","print_next_2_lines/print_second_line/p1/out:res":"print_next_2_lines/print_second_line/__fan_in__1/in:data[0]","print_next_2_lines/print_second_line/p2/out:err":"print_next_2_lines/print_second_line/out:err","print_next_2_lines/print_second_line/p2/out:res":"print_next_2_lines/print_second_line/__fan_in__1/in:data[1]","print_next_2_lines/print_second_line/p3/out:err":"print_next_2_lines/print_second_line/out:err","print_next_2_lines/print_second_line/p3/out:res":"print_next_2_lines/print_second_line/__fan_in__1/in:data[2]","print_next_2_lines/print_second_line/printf/out:err":"print_next_2_lines/print_second_line/out:err","print_next_2_lines/print_second_line/printf/out:sig":"print_next_2_lines/print_second_line/__fan_in__1/in:data[3]","print_next_2_lines/print_second_line/s/out:case[0]":"print_next_2_lines/print_second_line/__newv2__1/in:sig","print_next_2_lines/print_second_line/s/out:case[1]":"print_next_2_lines/print_second_line/__newv2__2/in:sig","print_next_2_lines/print_second_line/s/out:case[2]":"print_next_2_lines/print_second_line/__newv2__3/in:sig","print_next_2_lines/print_second_line/s/out:else":"print_next_2_lines/print_second_line/__fan_out__2/in:data","s/out:case[0]":"out:stop","s/out:else":"__fan_in__3/in:data[1]"}};

    // --- Data Parsing ---

    const components = new Map(); // Path -> { id, name, ports: Set, parent }
    const ports = new Map();      // Path -> { id, name, type: 'in'|'out', parentId }
    const links = [];

    function getPathInfo(fullPath) {
      // Format: path/to/component:port OR component:port
      const colonIdx = fullPath.lastIndexOf(':');
      let compPath = fullPath;
      let portName = "";
      
      if (colonIdx !== -1) {
        compPath = fullPath.substring(0, colonIdx);
        portName = fullPath.substring(colonIdx + 1);
      }
      
      return { compPath, portName };
    }

    function registerComponent(path) {
      if (components.has(path)) return;
      
      const parts = path.split('/');
      const name = parts[parts.length - 1];
      const parentPath = parts.length > 1 ? parts.slice(0, -1).join('/') : null;

      if (parentPath) registerComponent(parentPath);

      components.set(path, {
        id: path,
        name: name,
        parent: parentPath,
        type: 'component',
        val: 10
      });
    }

    function registerPort(fullPath, type) {
      const { compPath, portName } = getPathInfo(fullPath);
      if (!portName) return null; // Should not happen for ports

      registerComponent(compPath);

      const portId = fullPath;
      if (!ports.has(portId)) {
        ports.set(portId, {
          id: portId,
          name: portName,
          parentId: compPath,
          type: 'port',
          portType: type,
          val: 1
        });
      }
      return portId;
    }

    // 1. Parse Functions (Atomic Components)
    irData.funcs.forEach(func => {
      // We need to find the component path. 
      // We look at IO to find the ports, and from ports we derive component path.
      let foundPath = null;
      
      // Register input ports
      if (func.io.in) {
        func.io.in.forEach(p => {
          registerPort(p, 'in');
          foundPath = getPathInfo(p).compPath;
        });
      }
      // Register output ports
      if (func.io.out) {
        func.io.out.forEach(p => {
          registerPort(p, 'out');
          foundPath = getPathInfo(p).compPath;
        });
      }

      // If we found a component, mark it as atomic/leaf and store ref type
      if (foundPath && components.has(foundPath)) {
        const comp = components.get(foundPath);
        comp.isAtomic = true;
        comp.ref = func.ref;
        if (func.msg) comp.msg = func.msg;
      }
    });

    // 2. Parse Connections (Links)
    Object.entries(irData.connections).forEach(([src, dst]) => {
      // Register ports if not exists (implicit boundaries)
      const srcId = registerPort(src, 'out'); // Source is an output of someone
      const dstId = registerPort(dst, 'in');  // Dest is an input of someone

      if (srcId && dstId) {
        links.push({
          source: srcId,
          target: dstId,
          type: 'data'
        });
      }
    });

    // 3. Build Graph Data
    // We want nodes for:
    // - All Ports (visible satellite nodes)
    // - All Atomic Components (center nodes)
    // - We do NOT make nodes for Non-Atomic components (Clusters) in the force simulation,
    //   but we will use them for visual grouping.
    
    const graphNodes = [];
    const graphLinks = [...links];

    // Add Component Nodes
    components.forEach(comp => {
      if (comp.isAtomic) {
        graphNodes.push(comp);
      }
    });

    // Add Port Nodes
    ports.forEach(port => {
      graphNodes.push(port);
      
      // Add structural link to parent
      if (components.get(port.parentId)?.isAtomic) {
        graphLinks.push({
          source: port.parentId,
          target: port.id,
          type: 'structure'
        });
      }
    });

    // --- Visualisation ---

    const Graph = ForceGraph3D()
      (document.getElementById('3d-graph'))
        .graphData({ nodes: graphNodes, links: graphLinks })
        .nodeLabel('name')
        .nodeThreeObject(node => {
          if (node.type === 'component') {
            // Atomic Component: Box
            const group = new THREE.Group();
            
            // Color based on ref type
            let color = '#cccccc';
            if (node.ref?.startsWith('new')) color = '#aaffaa';
            else if (node.ref === 'lock') color = '#ffaaaa';
            else if (node.ref === 'switch_router') color = '#aaaaff';
            else if (node.ref === 'println') color = '#ffffaa';

            const mesh = new THREE.Mesh(
              new THREE.BoxGeometry(20, 10, 10),
              new THREE.MeshLambertMaterial({ color: color, opacity: 0.9, transparent: true })
            );
            group.add(mesh);

            const sprite = new SpriteText(node.name);
            sprite.color = 'white';
            sprite.textHeight = 4;
            sprite.position.y = 8;
            group.add(sprite);

            if (node.msg) {
               const val = node.msg.str || node.msg.int || "";
               const valSprite = new SpriteText(val.toString());
               valSprite.color = '#333';
               valSprite.textHeight = 2;
               valSprite.position.z = 6;
               group.add(valSprite);
            }

            return group;
          } else {
            // Port: Small Sphere
            const color = node.portType === 'in' ? '#55ff55' : '#ff5555';
            return new THREE.Mesh(
              new THREE.SphereGeometry(2),
              new THREE.MeshLambertMaterial({ color: color })
            );
          }
        })
        .linkWidth(link => link.type === 'structure' ? 0 : 1)
        .linkVisibility(link => link.type !== 'structure') // Hide structural links
        .forceEngine('d3')
        .d3Force('charge', d3.forceManyBody().strength(node => node.type === 'component' ? -100 : -10))
        .d3Force('link', d3.forceLink().id(d => d.id).distance(link => link.type === 'structure' ? 15 : 50).strength(link => link.type === 'structure' ? 1 : 0.1))
        .onEngineTick(() => {
           // Custom Logic to draw Hierarchical Boxes?
           // We can't easily draw transparent boxes in 'onEngineTick' with 3d-force-graph API efficiently 
           // without accessing the scene directly.
           // But we can access Graph.scene()
        });

    // Add Hierarchy Visuals (Bounding Boxes)
    // We need to update them every frame.
    
    const hierarchyGroups = new Map(); // Path -> Mesh

    // Initial scene setup for hierarchy
    const scene = Graph.scene();
    
    // Helper to collect descendant nodes of a component path
    function getDescendants(path) {
       const descendants = [];
       graphNodes.forEach(n => {
         if (n.id === path || (n.parentId && n.parentId.startsWith(path))) {
           descendants.push(n);
         }
       });
       return descendants;
    }

    // Create meshes for non-atomic components
    components.forEach(comp => {
      if (!comp.isAtomic) {
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, opacity: 0.1, transparent: true });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.visible = false; // Start invisible
        scene.add(mesh);
        hierarchyGroups.set(comp.id, { mesh, comp });
      }
    });

    // Update loop
    setInterval(() => {
      hierarchyGroups.forEach(({ mesh, comp }) => {
        const descendants = getDescendants(comp.id);
        if (descendants.length === 0) return;

        // Calculate Bounding Box
        const min = new THREE.Vector3(Infinity, Infinity, Infinity);
        const max = new THREE.Vector3(-Infinity, -Infinity, -Infinity);
        
        let valid = false;
        descendants.forEach(n => {
          if (n.x !== undefined && n.y !== undefined && n.z !== undefined) {
             min.x = Math.min(min.x, n.x);
             min.y = Math.min(min.y, n.y);
             min.z = Math.min(min.z, n.z);
             max.x = Math.max(max.x, n.x);
             max.y = Math.max(max.y, n.y);
             max.z = Math.max(max.z, n.z);
             valid = true;
          }
        });

        if (valid) {
          // Add padding
          const padding = 10;
          min.subScalar(padding);
          max.addScalar(padding);

          const size = new THREE.Vector3().subVectors(max, min);
          const center = new THREE.Vector3().addVectors(min, max).multiplyScalar(0.5);

          mesh.position.copy(center);
          mesh.scale.copy(size);
          mesh.visible = true;
        }
      });
    }, 1000 / 60); // 60 FPS update

  </script>
</body>
</html>
